<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Serveur orangepi-raspberry nextcloud en photovolta√Øque autonome</title>
  <style>
    body {
      font-family: "Helvetica", Arial, sans-serif;
      max-width: 800px;
      margin: auto;
      background-color: #fafafa;
      color: #222;
      line-height: 1.6;
      padding: 20px;
    }

    h1 {
      color: #210dfd8b;
      border-bottom: 2px solid #ce510dff;
      padding-bottom: 0.2em;
    }

    h2 {
      color: #333;
      margin-top: 1.5em;
    }

    ul, ol {
      margin-left: 1.5em;
    }

    /* Sous-listes dans les √©tapes */
    ol > li ul {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }

    ol > li strong {
      color: #444;
      display: block;
      margin-bottom: 0.3em;
    }

    .section {
      margin-bottom: 2em;
      background: #fff;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* Styliser le titre principal de chaque √©tape : encadr√© gris et police un peu plus grande
       Cibl√© uniquement dans la section √âtapes (classe .steps) pour √©viter d'impacter d'autres <strong>. */
    .section.steps > ol > li > strong:first-child {
      display: block;
      background: #f3f3f3; /* gris tr√®s clair */
      color: #222;
      padding: 0.45rem 0.6rem;
      border: 1px solid #d6d6d6;
      border-radius: 6px;
      font-size: 1.06em; /* l√©g√®rement plus grand */
      margin-bottom: 0.45rem;
    }

    /* Mat√©riaux: rendre les sous-items gris√©s et en police plus petite */
    .section.materials ul ul {
      color: #666;
      font-size: 0.9em;
      margin-top: 0.35em;
    }

    /* (Step title framed styles were removed per user request to revert) */

    .step-images {
      margin: 1em 0;
      display: grid;
      gap: 0.6rem;
    }

  /* Layout for image boxes: adjust columns based on count via classes .count-N */
  .step-images.count-1 { grid-template-columns: 1fr; }
  .step-images.count-2 { grid-template-columns: repeat(2, 1fr); }
  .step-images.count-3 { grid-template-columns: repeat(3, 1fr); }
  /* For 4 or more images, use 2 columns thumbnail layout for a more harmonious small-preview look */
  .step-images.count-4,
  .step-images.count-5,
  .step-images.count-6,
  .step-images.count-7,
  .step-images.count-8,
  .step-images.count-9,
  .step-images.count-10 { grid-template-columns: repeat(2, 1fr); }

    /* container box around the whole set of images for the step */
    .step-images {
      margin: 1em 0;
      display: grid;
      gap: 0.6rem;
      background: #fafafa; /* subtle gray background */
      border: 1px solid #e6e6e6;
      padding: 0.6rem;
      border-radius: 8px;
    }

    figure {
      margin: 0;
      text-align: center;
      background: transparent;
      padding: 0.25rem 0;
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Thumbnails: show the whole image (no cropping). Use contain with max dims so
       small images display fully while larger images are constrained. Center them. */
    .step-images figure img {
      width: auto;
      max-width: 100%;
      max-height: 160px; /* control thumbnail height but do not crop */
      object-fit: contain; /* show full image */
      background: #f5f5f5; /* subtle neutral background for small images */
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      cursor: zoom-in;
      display: block;
      margin: 0 auto; /* center narrower images */
    }
    /* Single-image steps: let the image take available width while preserving aspect */
    .step-images.count-1 figure img {
      width: 100%;
      height: auto;
      object-fit: contain;
      max-height: none;
    }

    /* Hide figcaptions in thumbnail/grid mode; captions are shown in the lightbox */
    .step-images figure figcaption { display: none; }

    figcaption {
      font-size: 0.9em;
      color: #666;
      margin-top: 0.5em;
      font-style: italic;
    }
    

    /* Lightbox overlay */
    .lightbox-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.75);
      z-index: 9999;
      padding: 1rem;
    }
    .lightbox-overlay.active { display: flex; }
    .lightbox-content {
      max-width: 95%;
      max-height: 95%;
      text-align: center;
    }
    .lightbox-content img {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 6px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    }
    .lightbox-caption { color: #fff; margin-top: 0.6rem; font-size: 0.95em; }
    .lightbox-close {
      position: absolute; top: 12px; right: 16px; color: #fff; background: transparent;
      border: none; font-size: 1.6rem; cursor: pointer;
    }

    footer {
      margin-top: 2em;
      font-size: 0.9em;
      color: #666;
      border-top: 1px solid #ddd;
      padding-top: 1em;
    }

    /* Style impression PDF */
    @media print {
      body { background: white; color: black; }
      a { color: black; text-decoration: none; }
      .section { box-shadow: none; border: 1px solid #ccc; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Serveur orangepi-raspberry nextcloud en photovolta√Øque autonome</h1>
    
      <div style="text-align:center; margin-bottom:1.2em;">
        <img src="https://wiki.lowtechlab.org/images/thumb/e/e9/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_171328_268.jpg/ia-213999d69d8ff5203536557442d98d30-px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_171328_268.jpg.png" alt="Image principale du tutoriel" style="max-width:100%; max-height:320px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
        
          <div style="color:#666; font-size:0.97em; margin-top:0.4em; font-style:italic;">Tutoriel pour mettre en place un serveur nextcloud (√©quivalent drive google mais libre et adapt√© √† l'organisation collective) sur un ordinateur monocarte autonome (aliment√© en photovolta√Øque avec stockage) Ce tutoriel n'est pas tout √† fait "lowtech" en premi√®re approche dans la mesure o√π il s'agit d'informatique et de photovoltaique. Cependant, il se veut le plus didactique possible et rejoint la philosophie lowtech de partager les savoirs faires, √©viter la tech inaccessible par la r√©tention d'information, la complexification by design ou la d√©pendance propri√©taire by design. On donne aussi un outil de dimensionnement photovolta√Øque avec quelques explication. A vous de dimensionner pour une informatique lowtech, qui ne fonctionne que sur une plage horaire cal√© sur les rythmes du soleil, cad qui respecte les temporalit√©s humaines. Nextcloud (service accessible sur framasoft ici : https://www.frama.space/abc/fr/) est un service assez cool pour s'organiser √† plusieurs et permet de partager des fichiers, avoir un annuaire, un chat, de travailler en cooperation sur des fichiers libreoffice voire m√™me de faire des visios. On peut aussi imaginer des infokiosques mobiles sur ce principe. Le tuto remet en question le march√© des vpns, le photovoltaique avec stockage neuf et cher (en r√©alit√© le photovoltaique est devenu trop competitif face au p√©trole et encore plus face au nucl√©aire!), et le march√© des gafam et leur design de surveillance nocif pour la confiance et le lien social. Les commandes sont celles pour un systeme debian Enfin, le tuto est fait avec un modem 4G (et connexion filaire √† un orange pi qui n'a pas de carte wifi par d√©faut), et mis a jour ce 10 avril pour raspberry pi connect√© au "partage wifi" de votre t√©l√©phone. (voir etap 6 pour wifi en wpa3 et etap 16 pour wifi en wpa2)</div>
        
      </div>
    
    
      
        <p>Tutoriel pour mettre en place un serveur nextcloud (√©quivalent drive google mais libre et adapt√© √† l'organisation collective) sur un ordinateur monocarte autonome (aliment√© en photovolta√Øque avec stockage)</p>
      
        <p>Ce tutoriel n'est pas tout √† fait "lowtech" en premi√®re approche dans la mesure o√π il s'agit d'informatique et de photovoltaique.</p>
      
        <p>Cependant, il se veut le plus didactique possible et rejoint la philosophie lowtech de partager les savoirs faires, √©viter la tech inaccessible par la r√©tention d'information, la complexification by design ou la d√©pendance propri√©taire by design.</p>
      
        <p>On donne aussi un outil de dimensionnement photovolta√Øque avec quelques explication. A vous de dimensionner pour une informatique lowtech, qui ne fonctionne que sur une plage horaire cal√© sur les rythmes du soleil, cad qui respecte les temporalit√©s humaines.</p>
      
        <p>Nextcloud (service accessible sur framasoft ici : https://www.frama.space/abc/fr/) est un service assez cool pour s'organiser √† plusieurs et permet de partager des fichiers, avoir un annuaire, un chat, de travailler en cooperation sur des fichiers libreoffice voire m√™me de faire des visios.</p>
      
        <p>On peut aussi imaginer des infokiosques mobiles sur ce principe.</p>
      
        <p>Le tuto remet en question le march√© des vpns, le photovoltaique avec stockage neuf et cher (en r√©alit√© le photovoltaique est devenu trop competitif face au p√©trole et encore plus face au nucl√©aire!), et le march√© des gafam et leur design de surveillance nocif pour la confiance et le lien social.</p>
      
        <p>Les commandes sont celles pour un systeme debian</p>
      
        <p>Enfin, le tuto est fait avec un modem 4G (et connexion filaire √† un orange pi qui n'a pas de carte wifi par d√©faut), et mis a jour ce 10 avril pour raspberry pi connect√© au "partage wifi" de votre t√©l√©phone. (voir etap 6 pour wifi en wpa3 et etap 16 pour wifi en wpa2)</p>
      
    
    
    <p style="color: #666; font-size: 0.95em;">
      <strong>Difficult√© :</strong> Medium Moyen &nbsp;&nbsp; 
      <strong>Dur√©e :</strong> 3 hour(s) heure(s) &nbsp;&nbsp; 
      <strong>Co√ªt :</strong> 165 EUR (‚Ç¨)
    </p>
    
    <p style="font-size:0.95em; color:#066; margin-top:0.2em;">
      <strong>Lien du tutoriel de base :</strong>
      <a href="https://wiki.lowtechlab.org/wiki/Serveur_orangepi-raspberry_nextcloud_en_photovolta√Øque_autonome" target="_blank" rel="noopener" style="color:#066;">https://wiki.lowtechlab.org/wiki/Serveur_orangepi-raspberry_nextcloud_en_photovolta√Øque_autonome</a>
    </p>
    
    
  </header>

  <div class="section materials">
    <h2>üõ†Ô∏è Mat√©riaux</h2>
    
      <p><em>Non sp√©cifi√©</em></p>
    
  </div>

  <div class="section">
    <h2>üîß Outils</h2>
    
      <ul>
        <li><ul><li>autonomie.ods</li></ul></li>
      </ul>
    
  </div>

  <div class="section steps">
    <h2> √âtapes</h2>
    
      <ol>
        
          <li>
            
            
              <strong>1. √âtape 1 - Materiel</strong><div class='step-images count-6'><figure><img src='https://wiki.lowtechlab.org/images/thumb/1/15/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_192859_778.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_192859_778.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome IMG 20230821 192859 778.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/d/d4/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_192848_031.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_192848_031.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome IMG 20230821 192848 031.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/3/3c/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_192924_391.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_192924_391.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome IMG 20230821 192924 391.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/0/01/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_192908_135.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_192908_135.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome IMG 20230821 192908 135.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/8/89/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_171056_521.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_171056_521.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome IMG 20230821 171056 521.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/4/4c/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_DRL.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_DRL.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome DRL.jpg' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>Les liens vers le materiel photovolta√Øque utilis√© sont dans le fichier autonomie.ods ( lisible avec libreoffice) attach√© √† ce tutoriel.</li><li>- raspberry pi :</li><li>42‚Ç¨ sur leboncoin</li><li>-Orange pi :</li><li>Carte utilis√©e: Orange pi 5</li><li>ordinateur monocarte avec 4,8,16 ou 32 Go de ram</li><li>Un processeur √† 2,4Ghz ARM Cortex-A55</li><li>Cette carte est compatible avec les disques nvme pcie 2.0 ssd 2242 ou 2230 (le pcie √©tant r√©trocompatible cad que les 3.0, 4.0, 5.0 fonctionnent √† vitesse r√©duite sur l'orange pi 5)</li><li>Meme principe qu'ici Ordinateur low-tech mais un peu plus puissant et on peut y brancher un disque dur (pratique pour nextcloud qui est fait pour h√©berger des fichiers) et ca d√©marre tout seul sur cl√© usb.</li><li>Prix: 143‚Ç¨ neuf sur aliexpress en version 16 Go au 2 ao√ªt 2023</li><li>En occasion leboncoin, on trouve plus facilement des raspberry aux alentours de 100‚Ç¨.</li><li>Il est n√©cessaire d'acheter une petit boitier √† 10‚Ç¨ (ou en fabriquer un ) en plus pour √©viter que la carte soit √† nue</li><li>-Stockage/disque dur:</li><li>Ici on utilise une cl√© usb Kingston 32Go et une carte nvme samsung de 512Go.</li><li>On peut brancher une disque dur de plus grande capacit√© soit en usb, soit une carte nvme (nvme pcie 2.0 ssd 2242 ou 2230. compatible avec les pcie 3.0 4.0 et superieur mais la vitesse est r√©duite).</li><li>Une carte nvme samsung 2242 de 500Go coute 50‚Ç¨ environ au 2 ao√ªt 2023.</li><li>-cl√© usb : 10‚Ç¨</li><li>-cable rj45: 5‚Ç¨</li><li>-Box internet ou modem 4G selon votre connection internet.</li><li>-Panneau solaire: Ici on utilise un panneau flexible de 120W achet√© 115‚Ç¨ neuf mais on en trouve √† 30‚Ç¨ d'occasion sur leboncoin √©quivalent en puissance.</li><li>Note: Pour le besoin th√©orique. Voir fichier autonomie.ods</li><li>-batterie de voiture us√©e: utiliser sa pr√©c√©dente batterie de voiture plomb acide lorsqu'elle commence √† lacher quand il fait trop chaud!</li><li>-convertisseur batterie 12/24V-usb 5V: 20‚Ç¨ evitez amazon si vous le pouvez)</li><li>- regulateur pwm 30A: 30‚Ç¨ neuf si on ne prend pas de la marque</li><li>- DRL (interupteur jour/nuit 13V): 1,5‚Ç¨ neuf</li><li>(mot cl√© "Kit de feux de jour √† LED pour voiture, contr√¥leur marche/arr√™t automatique DRL")</li><li>-cable electrique mc4: 20‚Ç¨</li><li>Total prix d'occasion orangepi: 256,50‚Ç¨</li><li>Total prix neuf orangepi: 431,50‚Ç¨</li><li>Total prix d'occasion raspberry: 165‚Ç¨</li><li>Voir fichier autonomie.ods</li><li>-</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>2. √âtape 2 - Installation de nextcloud 1/4</strong><div class='step-images count-6'><figure><img src='https://wiki.lowtechlab.org/images/thumb/7/75/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_10.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_10.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 10.png' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/3/3b/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_02.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_02.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 02.png' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/c/c1/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_01.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_01.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 01.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/3/31/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_02.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_02.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 02.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/a/af/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_03.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_03.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 03.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/8/82/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_04.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_04.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 04.jpg' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>1.T√©l√©chargement de dietpi et pr√©paration de la cl√© usb</li><li>Pour l'installation, je vous conseille d'utiliser dietpi. L'interet de dietpi est notamment la legeret√© du systeme pour des ordinateurs monocartes, mais aussi l'installation automatique de logiciels libres par un menu relativement "user friendly". On peut mentionner parmis tous les logiciels installables automatiquement au d√©marrage du systeme (https://dietpi.com/dietpi-software.html) des applis de domotique, interessante pour √©conomiser de l'√©nergie en fonction de la meteo, mais aussi les relais "tor" pour contribuer au r√©seau relativement anonymisant tor, interessant pour les "√©co terroristes" que nous sommes.</li><li>Il faut aussi mentionner "younohost" (https://yunohost.org/fr) qui est fran√ßais et qui fait le m√™me boulot que dietpi pour les raspberry et qui est aussi "user friendly" sinon plus. Je n'ai pas encore test√© yunohost car j'avais mis de c√¥t√© le raspberry pi suite √† des bugs de souris trop √©tranges. Mes recherches pour √©viter les bugs de souris trop √©tranges n'ayant pas abouti positivement (purism, odroid, raspberry, orangpi, macbook, windows, voir section s√©curit√©), je ne peux que faire √©tat de ce que j'ai effectivement essay√©.</li><li>https://dietpi.com/#download</li><li>( pour younohost : https://yunohost.org/fr/install/hardware:arm)</li><li>Selectionner votre ordinateur monocarte (orange pi dans le cas pr√©sent) puis telecharger</li><li>Dezipper l'archive obtenue.</li><li>Utiliser ensuite balena etcher pour cr√©er une cl√© usb bootable pour installer dietpi sur votre ordinateur monocarte (orange pi 5 dans le cas pr√©sent mais ca fonctionne pareil sur d'autres ordinateurs monocartes).</li><li>https://etcher.balena.io/#download-etcher</li><li>Double cliquer sur le fichier t√©l√©charg√©</li><li>Selectionner l'image de dietpi t√©l√©charg√©e, selectionner votre cl√© usb, cliquer sur flash.</li><li>Il ne vous reste plus qu'√† brancher la cl√© usb sur le orangepi et il bootera automatiquement sur la cl√© usb.</li><li>Pour un raspberry pi, on utilise une carte sd mais on peut configurer le boot usb √©galement (voir ici : https://makerhelp.fr/booter-un-raspberry-pi-4-sur-un-disque-dur-ou-un-ssd-en-usb/).</li><li>2. Installation de nextcloud</li><li>Allumer votre orangepi/raspberrypi avec la cl√© usb branch√©e.</li><li>Le login par d√©faut au d√©marrage est root et le mot de passe dietpi.</li><li>Suivre les menus que vous propose dietpi au premier d√©marrage pour installer le service nextcloud. C'es tr√®s facile, c'est en anglais et tout est automatis√©. J'ai mis les images des menus √† s√©lectionner pour l'installation de nextcloud dans cette etape et les √©tapes 3 √† 6.</li><li>Vous pouvez vous d√©placer dans les menus au clavier avec les fleches et la touche tab.</li><li>Selectionner avec espace et valider avec entree.</li><li>Voir images des √©tapes 3 √† 6 pour le d√©roulement de l'installation et les entr√©es √† s√©lectionner.</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>3. √âtape 3 - Installation de nextcloud 2/4</strong><div class='step-images count-6'><figure><img src='https://wiki.lowtechlab.org/images/thumb/9/99/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_05.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_05.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 05.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/4/4f/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_06.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_06.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 06.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/4/40/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_07.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_07.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 07.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/0/0c/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_08.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_08.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 08.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/1/10/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_09.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_09.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 09.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/8/87/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_10.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_10.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 10.jpg' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>Voir images</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>4. √âtape 4 - Installation de nextcloud 3/4</strong><div class='step-images count-6'><figure><img src='https://wiki.lowtechlab.org/images/thumb/f/f9/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_11.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_11.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 11.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/0/02/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_12.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_12.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 12.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/7/7e/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_13.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_13.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 13.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/0/0c/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_14.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_14.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 14.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/b/b4/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_15.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_15.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 15.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/5/54/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_16.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_16.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 16.jpg' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>Voir images</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>5. √âtape 5 - Installation de nextcloud 4/4</strong><div class='step-images count-5'><figure><img src='https://wiki.lowtechlab.org/images/thumb/a/a7/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_17.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_17.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 17.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/2/26/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_18.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_18.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 18.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/f/f7/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_19.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_19.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 19.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/0/02/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_20.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_20.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 20.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/e/eb/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_21.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_21.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 21.jpg' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>Voir images</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>6. √âtape 6 - configuration du reseau local ethernet ou wifi</strong><div class='step-images count-1'><figure><img src='https://wiki.lowtechlab.org/images/4/47/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_change-ubuntu-ip-address-step-7.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome change-ubuntu-ip-address-step-7.jpg' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>Si vous n'avez pas de box et que vous avez un orangepi ou un raspberrypi et que vous voulez vous connecter √† un wifi (par exemple le wifi d'un smartphone en partage de connexion)</li><li>Dietpi fournit un utilitaire pour configurer automatiquement le wifi qui fonctionne sur raspberry. Chez moi ca ne fonctionne que si le r√©seau est en wpa2. Si vous voulez activer le WPA3 ou si vous voulez configurer votre wifi √† la main, voici les √©tapes √† suivre.</li><li>Linux est un peu compliqu√© pour la gestion des r√©seaux. Il existe une multitude de programmes permettant de g√©rer les r√©seaux (networking, network interfaces, ifup, wpa_supplicant, network_manager, ifconfig, ip...).</li><li>Si vous vous y connaissez je vous laisse choisir ce qui vous convient le mieux.</li><li>Sinon, on utilisera les programmes install√©s par d√©faut dans dietpi pour la gestion des interfaces wifi : wpa_supplicant et dhclient.</li><li>Commencer par brancher un adaptateur usb wifi √† votre orangepi ou verifier que votre adaptateur wifi sur votre raspberry pi est bien d√©tect√©.</li><li>Sur un orangepi: verifier que l'adaptateur est bien d√©tect√© en tapant</li><li>Cette commande va lister les p√©riph√©riques usb et vous devriez voir votre cl√© usb wifi dans la liste. Verifier ensuite que les drivers de votre cl√© ont bien √©t√© charg√©s en tapant:</li><li>ou pour lire tous les pilotes charg√©s par linux en tapant</li><li>Vous pouvez trouver √† cette adresse une liste d'adaptateur usb qui fonctionnent nativement sous linux : https://github.com/morrownr/USB-WiFi/blob/main/home/USB_WiFi_Adapters_that_are_supported_with_Linux_in-kernel_drivers.md</li><li>Sur un orange pi ou raspberry pi : taper la commande</li><li>Vous devriez voir votre adaptateur wifi sous le nom d'interface wlan0. On supposera dans la suite du tuto que le nom de l'interface est wlan0. Si ce n'est pas le cas, remplacer wlan0 par le nom de votre interface.</li><li>Nou allons v√©rifier que votre interface est bien d√©clar√©e. Ouvrir le fichier /etc/network/interfaces en tapant:</li><li>Vous devez avoir les lignes suivantes. Si elles n'y sont pas ajouter les.</li><li>Nous allons maintenant configurer wpa_supplicant pour activer la connection wifi.</li><li>Pour cela, editer le fichier /etc/wpa_supplicant/wpa_supplicant.conf en tapant les commandes suivantes: (remplacer votre.ssid par le nom que vous donnez √† votre reseau wifi et votre.password par votre mot de passe)</li><li>Maintenant, la configuration differe si votre wifi est un wifi WPA2 ou WPA3.</li><li>Si cest un wpa2, ajouter:</li><li>Si cest un wpa3, ajouter:</li><li>Lancer maintenant wpa_supplicant avec les commandes:</li><li>Lancer ensuite dhclient pour obtenir une ip sur votre reseau:</li><li>Verifier que vous etes connect√©:</li><li>Voil√† vous √™tes connect√©.</li><li>Si ca ne fonctionne pas bien chez vous, je vous conseille les liens suivants pour d√©bugguer ou comprendre mieux √† quoi servent ces commandes: https://wiki.archlinux.org/title/Wpa_supplicant https://doc.ubuntu-fr.org/wifi_ligne_de_commande https://www.linuxbabe.com/command-line/ubuntu-server-16-04-wifi-wpa-supplicant</li><li>Pour automatiser la connection au d√©marrage de l'ordinateur:</li><li>Votre fichier doit ressembler √† cela:</li><li>Lancer ensuite la commande pour automatiser le demarrage du service au boot:</li><li>Editer ensuite le service dhclient pour automatiser son demarrage:</li><li>Ajouter le texte suivant :</li><li>puis lancer la commande:</li><li>Si vous avez une box:</li><li>Brancher le orangepi ou le raspberry pi √† votre box internet</li><li>(avec un cable rj45 pour le orange pi qui n'a pas le wifi par d√©faut, avec un cable rj45 ou en wifi pour votre raspberry pi)</li><li>Pour obtenir l'ip de votre dietpi ou raspberry pi, taper la commande suivante:</li><li>ip a</li><li>L'adresse ip s'affiche (192.168.2.2 sur l'image jointe)</li><li>Verifier que votre serveur est accessible depuis un autre ordinateur connect√© √† votre box ou routeur connect√© au modem 4g ou r√©seau wifi en tapant dans la barre de votre navigateur (en remplacant adresse_ip par l'adresse trouv√©e avec la commande ip a)</li><li>http://adresse_ip/nextcloud/</li><li>Rendre votre r√©seau local accessible depuis internet:</li><li>Si vous n'avez pas de box internet (reseau wifi de votre telephone ou modem 4g ou box 4g, se reporter aux etapes 7 et 8)</li><li>Si vous avez une box internet:</li><li>Pour rendre votre dietpi accessible depuis internet, il faut aller dans la configuration de votre box et</li><li>dans la section "NAT" "Port Forwarding" mettre le port 80 et renseigner l'ip trouv√©e pr√©cedemment ainsi que le port 443 et renseigner l'ip trouv√©e pr√©c√©demment √©galement.</li><li>Je n'ai pas de box donc je n'ai pas pu vous faire de screenshot mais vous trouverez des ressources sur internet pour cela. Par exemple https://pratiquepc.fr/ouvrir-des-ports-sur-une-livebox/</li><li>Si vous voulez vous connecter en ssh √† votre serveur dietpi depuis un autre ordinateur:</li><li>Pour se connecter en ssh sans login avec dropbear au orange pi/raspberry pi</li><li>copier votre cl√© publique ssh dans le fichier authorized_keys</li><li>plac√© dans ~/.ssh/authorized_keys</li><li>ne pas oublier de faire un chmod 0600 sur ce fichier</li><li>Pour le orange pi, qui utilise dropbear:<ul><li>ajouter la ligne DROPBEAR_EXTRA_ARGS="-s"</li></ul></li><li>au fichier /etc/default/dropbear</li><li>Vous pouvez ensuite trouver votre ip publique (celle accessible par tous sur internet) en tapant depuis votre console dietpi</li><li>curl ifconfig.me</li><li>(si curl n'est pas install√© lancer la commande apt update && apt install curl)</li><li>Une fois la configuration NAT/Port Forwarding effectu√©, tester si nextcloud est accessible sur internet en rentrant l'adresse suivante dans la barre de votre navigateur internet:</li><li>http://adresse_ip_publique/nextcloud/</li><li>(remplacer adresse_ip_publique par l'adresse trouv√©e pr√©c√©demment</li><li>Attention les navigateurs peuvent √™tre un peu capricieux sans le https, si vous voulez tester en sortant du diagnostic une possible erreur navigateur taper dans un terminal linux :</li><li>curl http://adresse_ip_publique/nextcloud/</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>7. √âtape 7 - configuration d'un vpn wireguard pour rendre accessible votre serveur depuis une box 4g ou un modem 4g</strong><div class='step-images count-2'><figure><img src='https://wiki.lowtechlab.org/images/thumb/0/02/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_gandi_1.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_gandi_1.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome gandi 1.png' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/1/10/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_gandi_2.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_gandi_2.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome gandi 2.png' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>[ATTENTION, cette section remet en question le march√© des vpns!!]</li><li>Cette section n'est utile que pour les connections 4G ou en wifi sur t√©l√©phone (4G ou 5G)</li><li>La 4g a l'avantage d'√™tre mobile, avec une tres faible consommation du modem autour de 5W, et vous pouvez trouver des modems 4g sans wifi pour limiter la surface d'attaque de votre serveur (exemple netgear lm1200 autour de 150‚Ç¨).</li><li>qu'est ce qu'un vpn?</li><li>Les VPN sont principalement connus pour les "clients" vpn. C'est √† dire que vous l'utilisez sur votre ordinateur pour vous "anonymiser".</li><li>Le vpn est en fait un tunnel entre votre ordinateur et un ordinateur distant √† partir duquel partent vos requetes vers internet. Tout votre traffic en direction d'internet va passer par ce tunnel.</li><li>Internet pense ainsi que vos requetes proviennent de cet ordinateur distant. C'est √† dire que votre ip publique devient celle de cet ordinateur distant.</li><li>Votre fournisseur d'acc√®s ne voit que le traffic entre votre ordinateur et cet ordinateur distant, ce qui vous "anonymise".</li><li>En r√©alit√©, vous √™tes anonyme vis √† vis de votre fournisseur d'acces √† internet, mais vous ne faites que d√©placer la confiance vers votre fournisseur vpn qui lui peut voir votre traffic.</li><li>Le vpn a aussi d'autres utilit√©s comme vous donner acc√®s √† des sites qui filtrent l'acc√®s selon la "provenance" de votre adresse ip publique.</li><li>Vous pouvez tout √† fait cr√©er votre propre serveur vpn, et dans notre cas, ce serveur vpn permettra de rediriger les requetes internet faites sur ce serveur vers votre orange pi/raspberry pi en passant par le tunnel (dans l'autre sens que lorsque vous l'utilisez en tant que client pour acc√©der √† internet).</li><li>Et nous allons voir comment.</li><li>Cr√©er un serveur sur gandi.net</li><li>Cr√©er un compte sur gandi.net, puis cr√©er un serveur dans gandicloud vps. Voir les images jointes pour la cr√©ation en 3 clics du serveur qui coute 5‚Ç¨/mois.</li><li>Pour cr√©er une cl√© ssh et se logger voir</li><li>https://docs.gandi.net/fr/hebergement_web/connexion/cle_ssh.html</li><li>https://docs.gandi.net/fr/cloud/operations_courantes/connexion_serveur.html</li><li>Une fois logg√© sur le serveur,</li><li>lancer la commande pour installer wireguard et les d√©pendances n√©cessaires</li><li>sudo apt update && sudo apt install wireguard resolvconf iptables nano -y</li><li>Lancer la m√™me commande sur votre orange pi/raspberry pi.</li><li>lancer ensuite les commandes suivantes sur votre serveur et sur le orange pi/raspberry pi pour creer les cles priv√©s et publiques de wireguard</li><li>sudo mkdir -p /etc/wireguard</li><li>sudo sh -c 'wg genkey | (umask 0077 && tee /etc/wireguard/private_key) | wg pubkey > /etc/wireguard/public_key'</li><li>Afficher la cl√© publique sur votre orange pi/raspberry pi en tapant</li><li>sudo cat /etc/wireguard/public_key</li><li>Afficher egalement la cl√© publique sur votre serveur en tapant</li><li>sudo cat /etc/wireguard/public_key</li><li>Entrer ensuite les commandes suivantes pour cr√©er un fichier de configuration /etc/wireguard/wg0.conf sur votre serveur:</li><li>Taper les lignes suivantes (remplacer cle_publique_du_orange_pi_ou_raspberry_pi par celle affich√©e pr√©c√©demment) :</li><li>echo "[Interface]" | sudo tee /etc/wireguard/wg0.conf<ul><li>echo "Address=10.10.0.1/24" | sudo tee -a /etc/wireguard/wg0.conf echo "PrivateKey=$(sudo cat /etc/wireguard/private_key)" | sudo tee -a /etc/wireguard/wg0.conf echo "ListenPort=12345" | sudo tee -a /etc/wireguard/wg0.conf echo "[Peer]" | sudo tee -a /etc/wireguard/wg0.conf echo "PublicKey=cle_publique_du_orange_pi_ou_raspberry_pi" | sudo tee -a /etc/wireguard/wg0.conf</li><li>echo "AllowedIPs=10.10.0.2/32" | sudo tee -a /etc/wireguard/wg0.conf</li></ul></li><li>Entrer ensuite la commande suivante sur le serveur pour lancer et activer le service vpn</li><li>sudo systemctl start wg-quick@wg0</li><li>sudo systemctl enable wg-quick@wg0</li><li>curl ifconfig.me</li><li>Taper les lignes suivantes (remplacer cle_publique_du_serveur par celle affich√©e pr√©c√©demment et ip_publique_du_serveur par celle affich√©e pr√©c√©demment) :</li><li>echo "[Interface]" | sudo tee /etc/wireguard/wg0.conf<ul><li>echo "Address=10.10.0.2/24" | sudo tee -a /etc/wireguard/wg0.conf echo "PrivateKey=$(sudo cat /etc/wireguard/private_key)" | sudo tee -a /etc/wireguard/wg0.conf echo "[Peer]" | sudo tee -a /etc/wireguard/wg0.conf echo "PublicKey=cle_publique_du_serveur" | sudo tee -a /etc/wireguard/wg0.conf echo "AllowedIPs=10.10.0.1/32" | sudo tee -a /etc/wireguard/wg0.conf</li><li>echo "Endpoint=ip_publique_du_serveur:12345" | sudo tee -a /etc/wireguard/wg0.conf</li><li>La ligne AllowedIPS d√©finit les ips de destination (sortantes) qui passeront par le tunnel et seront chiffr√©es mais aussi les ips entrantes autoris√©es. Si vous souhaitez configurer votre "client" (orange pi ou raspberry pi) pour utiliser le vpn pour acc√©der √† internet, remplacer AllowedIPs=10.10.0.1/32 par AllowedIPs=0.0.0.0/0 En d√©finissant 0.0.0.0/0 on indique que tout le traffic du orange pi/raspberry pi passera par le tunnel wireguard et toutes les ip entrantes seront autoris√©es. Il est alors important de bien configurer son firewall sur le serveur!</li></ul></li><li>Pour v√©rifier que wireguard fonctionne, lancer la commande suivante sur le serveur vpn:</li><li>ping 10.10.10.2 -c 4</li><li>Le ping doit fonctionner</li><li>Ca ne fonctionne de fa√ßon syst√©matique chez moi, mais je suis sur que si vous essayez loin de l'oeil de sauron votre m√©t√©o num√©rique ira mieux que la mienne, et ca fonctionnera chez vous ;)</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>8. √âtape 8 - configuration d'un vpn openvpn pour rendre accessible votre serveur depuis une box 4g ou un modem 4g</strong><div class='step-images count-6'><figure><img src='https://wiki.lowtechlab.org/images/thumb/2/25/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen1.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen1.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome ovpnscreen1.png' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/d/d6/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen2.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen2.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome ovpnscreen2.png' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/8/8b/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen3.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen3.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome ovpnscreen3.png' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/c/c1/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen4.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen4.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome ovpnscreen4.png' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/7/7a/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen4.1.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen4.1.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome ovpnscreen4.1.png' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/4/4d/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen6.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_ovpnscreen6.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome ovpnscreen6.png' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>Dans le cas o√π ca ne fonctionnerait pas avec wireguard, vous pouvez utiliser openvpn, (qui est configurable sans ligne de commande √† la souris!).</li><li>Configuration du serveur proxy gandi.net: Pour cela suivez les √©tapes suivantes (https://openvpn.net/vpn-server-resources/installing-openvpn-access-server-on-a-linux-system/):</li><li>Update du 27/11/23: il n'y a pas de version bookworm d'openvpn-as disponible pour debian. Pensez √† installer debian version bullseye</li><li>apt update && apt -y install ca-certificates wget net-tools gnupg</li><li>wget https://as-repository.openvpn.net/as-repo-public.asc -qO /etc/apt/trusted.gpg.d/as-repository.asc<ul><li>echo "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/as-repository.asc] http://as-repository.openvpn.net/as/debian bullseye main" | sudo tee /etc/apt/sources.list.d/openvpn-as-repo.list</li></ul></li><li>apt update && apt -y install openvpn-as</li><li>Si les commandes ci-dessus ne fonctionnent pas, il est possible qu'openvpn ait mis a jour des √©l√©ments. Merci alors de se reporter √† https://openvpn.net/access-server/, s'inscrire, et suivre les instructions d'installation</li><li>Rendez vous ensuite sur la page de configuration du serveur: https://<adresse_ip_du_serveur></li><li>login:openvpn</li><li>password: indiqu√© dans le log de l'installation</li><li>screen 1: go to admin panel reentrer vos login/password</li><li>screen2: Network settings: Activer UDP seulement et port 1194 puis save settings</li><li>screen3: VPN Settings: remplir les champs comme indiqu√© sur le screenshot puis save settings</li><li>screen 4 et 5: User Management/User permission : changer le mot de passe dans local password et entrer l'adresse ip fixe du screeenshot puis save settings. Puis update running server. Pour vous reconnecter √† l'interface de configuration: https://adresse_ip_du_serveur:943</li><li>screen 6: User Management/User profile: cliquer sur new profile puis Cliquer sur create profile. Renommer le fichier de configuration t√©l√©charg√© en openvpn.conf Ouvrir le fichier de configuration et trouver la ligne auth-user-pass et la remplacer par la ligne suivante:</li><li>auth-user-pass auth.txt</li><li>Configuration du orangepi/raspberrypi Lancer ensuite sur le orangepi raspberry pi:</li><li>sudo apt update && sudo apt install openvpn</li><li>Copier le fichier de configuration t√©l√©charger vers /etc/openvpn/client/openvpn.conf sur votre orangepi/raspberry pi creer un fichier auth.txt dans /etc/openvpn/client/ dans lequel vous copiez les deux lignes suivantes en remplacant password par votre mot de passe:</li><li>openvpn password</li><li>Lancer ensuite le client vpn:</li><li>sudo systemctl start openvpn-client@openvpn</li><li>Si vous voulez que le client se connecte automatiquement au lancement de la machine taper</li><li>sudo systemctl enable openvpn-client@openvpn</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>9. √âtape 9 - Rediriger les requetes du serveur vpn vers le orange pi-raspberry pi</strong><p><strong>√âtapes :</strong></p><ol><li>Pour rediriger les requetes sur le serveur vers le orange pi / raspberry pi, on met en place un serveur logiciel web nginx:</li><li>sudo apt install nginx -y</li><li>On ouvre ensuite le fichier de configuration de ce logiciel serveur web:</li><li>sudo nano /etc/nginx/sites-enabled/default</li><li>Remplacer le contenu du fichier par ce qui suit:</li><li>server {</li><li>listen 80;</li><li>server_name localhost;</li><li>server_tokens off;<ul><li>add_header Permissions-Policy "accelerometer=(),autoplay=(),camera=(),display-capture=(),document-domain=(),encrypted-media=(),fullscreen=(),geolocation=(),gyroscope=(),magnetometer=(),microphone=(),midi=(),payment=(),picture-in-picture=(),publickey-credentials-get=(),screen-wake-lock=(),sync-xhr=(self),usb=(),web-share=(),xr-spatial-tracking=()";</li><li>add_header Strict-Transport-Security "max-age=31536000 ; includeSubDomains";</li></ul></li><li>add_header X-Frame-Options "SAMEORIGIN";</li><li>add_header X-Content-Type-Options nosniff;</li><li>add_header Content-Security-Policy "script-src 'self';";</li><li>add_header X-Permitted-Cross-Domain-Policies none;</li><li>add_header Referrer-Policy no-referrer;</li><li>add_header Clear-Site-Data "cache,cookies,storage";</li><li>location / {</li><li>proxy_pass http://10.10.0.2;</li><li>proxy_set_header Host $host;</li><li>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</li><li>proxy_set_header X-Real-IP $remote_addr;</li><li>proxy_set_header X-Forwarded-Proto $scheme;</li><li>client_max_body_size 20M;</li><li>limit_except GET HEAD POST {deny all;}</li><li>}</li><li>}</li><li>Nginx va rediriger les requetes faites sur l'ip publique de votre serveur vers le nextcloud de votre orange pi / raspberry pi (ligne proxy_pass http://10.10.0.2;)</li><li>Vous pouvez tester si cela fonctionne en vous rendant sur la page:</li><li>http://ip_publique_de_votre_serveur_gandi/nextcloud/</li><li>(notez bien que c'est en http et pas https)</li><li>Attention, de nombreux navigateurs n'acceptent plus tres bien les redirections en http, voir la section https pour configurer le https (il faudra prendre un nom de domaine).</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>10. √âtape 10 - Nom de domaine et adresse fixe</strong><div class='step-images count-1'><figure><img src='https://wiki.lowtechlab.org/images/thumb/5/5e/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_gandi3.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_gandi3.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome gandi3.png' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>Le nom de domaine est l'adresse dans votre navigateur : par exemple lowtechlab.org.</li><li>Il vous permet de rendre votre serveur accessible plus facilement avec une adresse facilement memorisable. Il ne fait qu'associer le nom de domaine √† l'adresse ip de votre serveur vpn ou l'adresse ip de votre box.</li><li>Que vous enregistriez un nom de domaine pour rediriger vers votre adresse ip ou pas (c'est n√©cessaire pour avoir le https cependant), il faut noter que par d√©faut, les fournisseurs d'acc√®s vous octroient une adresse ip diff√©rente √† chaque connexion.</li><li>Si vous souhaitez une adresse ip fixe, il faut en faire la demande √† votre fournisseur d'acc√®s. Ce n'est malheureusement plus tr√®s r√©pandue dans les offres grands publics. Orange propose √† la place un "DynDns" qui vous propose une adresse en lettres correspondant √† votre adresse ip mais √† laquelle vous ne pouvez pas rattacher facilement un nom de domaine. Certains gestionnaires de nom de domaine, comme infomaniak, proposent tout de m√™me d'enregistrer un nom de domaine pour le dyndns qui est acessible assez facilement sans surcout chez les principaux op√©rateurs.</li><li>Si vous avez un acc√®s en 4G, il n'est pas possible d'avoir une adresse ip fixe et votre adresse ip publique correspondra √† un "pool". C'est √† dire que l'op√©rateur alloue une adresse ip publique pour plusieurs clients, ne vous permettant pas d'utiliser la technique du NAT/Port Forwarding pour rendre votre dietpi accessible sur internet.</li><li>Il faudra alors prendre un nom de domaine pour votre serveur vpn qui redirige les requetes vers votre dietpi.</li><li>Voir image jointe pour l'enregistrement d'un nom de domaine: c'est la ligne nom "@" type A qu'il faut renseigner avec l'adresse ip publique de votre box ou de votre serveur vpn.</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>11. √âtape 11 - Configuration https sur serveur gandi vpn</strong><div class='step-images count-1'><figure><img src='https://wiki.lowtechlab.org/images/thumb/a/ab/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_Capture_d_cran_du_2023-08-21_18-47-32.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_Capture_d_cran_du_2023-08-21_18-47-32.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome Capture d cran du 2023-08-21 18-47-32.png' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>Si vous avez un serveur proxy</li><li>Sur votre serveur gandi, effectuer les op√©rations suivantes:</li><li>Creer un fichier /etc/nginx/conf.d/dietpi.conf et copier les lignes suivante:</li><li>server {</li><li>listen 80;</li><li>server_name localhost;</li><li>server_tokens off;<ul><li>add_header Permissions-Policy "accelerometer=(),autoplay=(),camera=(),display-capture=(),document-domain=(),encrypted-media=(),fullscreen=(),geolocation=(),gyroscope=(),magnetometer=(),microphone=(),midi=(),payment=(),picture-in-picture=(),publickey-credentials-get=(),screen-wake-lock=(),sync-xhr=(self),usb=(),web-share=(),xr-spatial-tracking=()";</li><li>add_header Strict-Transport-Security "max-age=31536000 ; includeSubDomains";</li></ul></li><li>add_header X-Frame-Options "SAMEORIGIN";</li><li>add_header X-Content-Type-Options nosniff;</li><li>add_header Content-Security-Policy "script-src 'self';";</li><li>add_header X-Permitted-Cross-Domain-Policies none;</li><li>add_header Referrer-Policy no-referrer;</li><li>#add_header Clear-Site-Data "cache,cookies,storage";</li><li>return 301 https://$host$request_uri;</li><li>location / {</li><li>return 301 https://$host$request_uri;</li><li>}</li><li>}</li><li>lancer ensuite les commandes suivantes:</li><li>sudo apt install letsencrypt</li><li>wget https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf sudo cp options-ssl-nginx.conf /etc/letsencrypt/options-ssl-nginx.conf wget https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem sudo cp ssl-dhparams.pem /etc/letsencrypt/ssl-dhparams.pem sudo rm /etc/nginx/sites-enabled/default sudo apt remove certbot</li><li>sudo apt install python3-certbot-nginx</li><li>obtenir les certificats (rempalcer __domain__ par votre domaine):</li><li>sudo certbot certonly --nginx -d __domain__</li><li>copier ensuite les lignes suivante dans votre fichier /etc/nginx/conf.d/dietpi.conf</li><li>en remplacant __domain__ par votre domaine</li><li>server {</li><li>listen 80;</li><li>server_name localhost;</li><li>server_tokens off;<ul><li>add_header Permissions-Policy "accelerometer=(),autoplay=(),camera=(),display-capture=(),document-domain=(),encrypted-media=(),fullscreen=(),geolocation=(),gyroscope=(),magnetometer=(),microphone=(),midi=(),payment=(),picture-in-picture=(),publickey-credentials-get=(),screen-wake-lock=(),sync-xhr=(self),usb=(),web-share=(),xr-spatial-tracking=()";</li><li>add_header Strict-Transport-Security "max-age=31536000 ; includeSubDomains";</li></ul></li><li>add_header X-Frame-Options "SAMEORIGIN";</li><li>add_header X-Content-Type-Options nosniff;</li><li>add_header Content-Security-Policy "script-src 'self';";</li><li>add_header X-Permitted-Cross-Domain-Policies none;</li><li>add_header Referrer-Policy no-referrer;</li><li>#add_header Clear-Site-Data "cache,cookies,storage";</li><li>return 301 https://$host$request_uri;</li><li>location / {</li><li>return 301 https://$host$request_uri;</li><li>}</li><li>}</li><li>server {</li><li>listen 443 ssl http2;</li><li>server_name localhost;</li><li>server_tokens off;</li><li>ssl_certificate /etc/letsencrypt/live/__domain__/fullchain.pem;</li><li>ssl_certificate_key /etc/letsencrypt/live/__domain__/privkey.pem;</li><li>include /etc/letsencrypt/options-ssl-nginx.conf;</li><li>ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;<ul><li>add_header Permissions-Policy "accelerometer=(),autoplay=(),camera=(),display-capture=(),document-domain=(),encrypted-media=(),fullscreen=(),geolocation=(),gyroscope=(),magnetometer=(),microphone=(),midi=(),payment=(),picture-in-picture=(),publickey-credentials-get=(),screen-wake-lock=(),sync-xhr=(self),usb=(),web-share=(),xr-spatial-tracking=()";</li><li>add_header Strict-Transport-Security "max-age=31536000 ; includeSubDomains";</li></ul></li><li>add_header X-Frame-Options "SAMEORIGIN";</li><li>add_header X-Content-Type-Options nosniff;</li><li>add_header Content-Security-Policy "script-src 'self';";</li><li>add_header X-Permitted-Cross-Domain-Policies none;</li><li>add_header Referrer-Policy no-referrer;</li><li>#add_header Clear-Site-Data "cache,cookies,storage";</li><li>location / {</li><li>proxy_pass http://10.10.10.2;</li><li>proxy_set_header Host $host;</li><li>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</li><li>proxy_set_header X-Real-IP $remote_addr;</li><li>proxy_set_header X-Forwarded-Proto $scheme;</li><li>client_max_body_size 20M;</li><li>limit_except GET HEAD POST {deny all;}</li><li>}</li><li>}</li><li>red√©marrer nginx</li><li>sudo systemctl restart nginx</li><li>Une fois ces √©tapes r√©alis√©es, votre serveur est accessible en ligne en https en tapant dans votre navigateur https://votre_domaine/nextcloud/</li><li>Vous pouvez alors configurer nextcloud en ligne par le compte administrateur login par d√©faut sur dietpi: admin mot de passe par d√©faut sur dietpi: mot de passe entr√©e √† l'installation de dietpi</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>12. √âtape 12 - Configuration https sur dietpi si vous etes branch√© en box</strong><p><strong>√âtapes :</strong></p><ol><li>Je n'ai pas de box, je vous updaterai quand ce sera le cas et prooftest√©! :)</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>13. √âtape 13 - Rendre votre serveur nomade et autonome √©nerg√©tiquement en photovoltaique</strong><div class='step-images count-2'><figure><img src='https://wiki.lowtechlab.org/images/thumb/3/39/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_2.6kWc.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_2.6kWc.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 2.6kWc.png' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/c/c9/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_9kWc.png/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_9kWc.png' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome 9kWc.png' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>Que ce soit pour des raisons √©cologiques, ou pour d'autres raisons, il est int√©ressant d'avoir un serveur autonome √©nerg√©tiquement,</li><li>qui ne d√©pendra pas des al√©as du r√©seau √©lectrique.</li><li>NB: pour une version l√©g√®rement modifi√© du dimensionnement photovolta√Øque (production moyenne/par intervalle cal√©e sur mod√®le jrc en d√©cembre au lieu du nombre d'heure d'ensoleillement minimum), voir mon autre tuto ici:</li><li>Dimensionner une installation photovolta√Øque autonome</li><li>videos:<ul><li>bases debutant(panneaux, regulateur, onduleur, conso/prod): https://www.youtube.com/watch?v=8Ft4XQj9lQ4</li><li>montage simple kit myshop solaires pour 230V: https://www.youtube.com/watch?v=SvmPEhPq_S8</li></ul></li><li>kit pr√™ts √† acheter (si vous avez des subventions et des coll√®gues qui coop√®rent bien):<ul><li>https://allo.solar/kit-solaire-1650w-230v-autoconsommation-aps.html?gclid=EAIaIQobChMIkY_fxvu-gAMVyLfVCh014gadEAYYASABEgJd8_D_BwE</li></ul></li><li>solution de stockage interm√©diaire int√©gr√©e (cher et pas tres lowtech):</li><li>Station √©nergie portable extensible 230V BLUETTI AC200MAX</li><li>EcoFlow River 2 pro</li><li>kits semi lowtech (celui utilis√© dans ce guide):</li><li>panneaux photovolta√Øque 120W et batterie de voiture plomb acide.</li><li>kit vraiment lowtech:</li><li>fabriquer sa batterie lithium √† partir de d√©chets: voir barnab√© chaillot<ul><li>https://www.youtube.com/watch?v=_hwj7Ds50lU</li></ul></li><li>rappel de base: branchement en s√©rie (+ sur - et + sur -) on ajoute le voltage et on garde le meme amperage, branchement en paralelle (+ sur +, - sur -) on ajoute l'amperage et on garde le meme voltage</li><li>idem pour les batteries: √† mettre en paralelle pour garder la meme tension (voltage)</li><li>La premi√®re probl√©matique du photovolta√Øque lowtech autonome est le dimensionnement de l'installation (Se reporter √† mon autre tuto</li><li>Dimensionner une installation photovolta√Øque autonome)</li><li>Pour cela on trouve pas mal d'informations sur internet.</li><li>Vous pouvez utiliser la feuille libreoffice en piece jointe en haut de ce tutoriel pour du dimensionnement "bricol√©".</li><li>Le dimensionnement - le besoin journalier:</li><li>Le orange pi consomme environ 20W</li><li>Un disque usb suppl√©mentaire consomme environ 5W</li><li>Un modem 4G consomme environ 5W</li><li>Soit un besoin constant de 35W en prenant 16% de marge d'erreur.<ul><li>Le besoin journalier pour un serveur qui tourne 24h/24: 35W*24h=840Wh</li></ul></li><li>Le besoin journalier pour un serveur qui tourne en journ√©ee seulement:<ul><li>en √©t√©: 35W*14h=490Wh</li><li>en hiver: 35W*8h=280Wh</li></ul></li><li>Notez qu'il s'agit l√† d'un besoin moyen et si vous souhaitez dimensionner</li><li>pour des usages divers, il est recommander de proc√©der de fa√ßon plus pr√©cise</li><li>en calculant les besoins temps r√©els.</li><li>Le dimensionnement du stockage par le temps d'autonomie :</li><li>Estimer les pertes √† 20% et augmenter le besoin en consqu√©nce:<ul><li>besoin 24h/24=840/0,80=1050Wh</li></ul></li><li>Estimer le temps d'autonomie voulue:</li><li>exemple 24h</li><li>On va alors dimensionner le stockage pour tenir 24h.<ul><li>Pour des batteries en 12V: 1050Wh/12V=87,5Ah</li></ul></li><li>Etant donn√© qu'on veut limiter la d√©charge des batteries √† 50%, on prendra donc<ul><li>87,5Ah/0,5=175Ah</li></ul></li><li>Soit 2100 Wh en 12V</li><li>Selon les caract√©ristiques des panneaux (voir feuille de calcul), on peut estimer la recharge de la batterie lorsque l'ensoleillement est minimal (en d√©cembre).</li><li>Le dimensionnement par la m√©thode du nombre de jours voulues pour recharger entierement les batteries:</li><li>Si on veut pouvoir recharger les batteries en un jour en hiver, il faut consid√©rer la puissance produite par vos panneaux au jour d'hiver avec le moins d'ensoleillement.</li><li>Si on prend 3,5h pour le minimum, le nombre de panneaux n√©cessaire de puissance x Watt sera:</li><li>C_batterie:Capacit√© batterie en Wh</li><li>Dans notre exemple 2100Wh</li><li>T_hiver:temps de recharge journalier minimal en hiver (en h)</li><li>Dans notre exemple 3,5h</li><li>B_hiver:besoin journalier hors temps ensoleillement en hiver (en Wh)<ul><li>Dans notre exemple (24h-3,5h)*35W=897Wh</li></ul></li><li>n_voulus:nombre de jour voulus pour recharger entierement la batterie</li><li>Dans notre exemple 1</li><li>I:amperage sortie d'un panneau photovoltaique</li><li>Dans notre exemple 7A</li><li>U:tension sortie d'un panneau photovoltaique</li><li>Dans notre exemple 12V<ul><li>Nb_panneaux=C_batterie+B_hiver*n_nvoulus/T_hiver*I*U*n_voulus</li></ul></li><li>Dans l'exemple:<ul><li>Nb_panneaux=(2100+897*1)/(3,5*12*7*1)</li></ul></li><li>Il faudra donc 10 panneaux de 84W de 7A 12V</li><li>Noter que la valeur cardinale ici est √† la ligne 42 du fichier joint, il s'agit</li><li>de l'ensoleillement journalier minimal en d√©cembre √† production nominale. Des valeurs de r√©f√©rence peuvent √™tre trouv√©es sur<ul><li>https://re.jrc.ec.europa.eu/api/v5_2/seriescalc?lat=44.203142&lon=0.616363&loss=14&angle=45&aspect=0&startyear=2005&endyear=2005&pvcalculation=1&peakpower=1&pvtechchoice=crystSi&browser=0&outputformat=csv</li></ul></li><li>Mais rien ne vaut une mesure empirique pour v√©rifier tout ca.</li><li>Le graphique en illustration provient du monitoring de deux installations √† 400km de distance d'une entreprise qui installe et suit du photovolta√Øque depuis 2018. J'attend de mesurer tout √ßa avec un voltmetre fiable sur plusieurs panneaux achet√©s d'occasions pour updater ce tuto en d√©cembre! :)</li><li>Tout commentaire et "retour d'experience" est bienvenu √† ce sujet en bas de cette page!</li><li>Le dimensionnement par la m√©thode essais et erreurs</li><li>La feuille de calcul propose aux lignes 41 et 42 d'ajuster le nombre de panneaux et le temps d'ensoleillement moyen en d√©cembre et donne le besoin journalier hors temps ensoleillement hiver en Wh et la recharge batterie journaliere maximale en hiver (en Ah et Wh). En faisant des essais sur les deux param√®tres, on peut obtenir le nombre de panneaux minimum pour que la(les) batterie(s) se recharge(nt) positivement en hiver.</li><li>La probl√©matique principale du photovolta√Øque lowtech autonome est le stockage de l'√©nergie.</li><li>Vous pouvez lire les caract√©ristiques des panneaux qu'on vous a donn√© ou trouv√©s sur leboncoin √† pas cher:</li><li>-puissance crete: elles s'aditionnent pour obtenir la puissance n√©cessaire trouv√©e lors de la phase de dimensionnement.</li><li>-tension : 12V,24V ou 48V. voir regles s√©rie/paralelle pour leur additions</li><li>-intensit√©: variable selon les mod√®les mais souvent inferieure √† 10A. voir regles s√©rie/paralelle pour leur additions</li><li>Pour recharger des batteries, en principe, si vous connectez votre panneaux en direct sur une batterie, il suffit que la tension √† la sortie de vos panneaux soit la m√™me que celles de vos batterie, et ca devrait charger.</li><li>Il y a un composants importants √† retenir pour charger correctement vos batteries:</li><li>le regulateur ou controleur de charge</li><li>il en existe de trois sortes: les tor (tout ou rien) les mppt (Maximum power point tracking) et les pwm (Pulse Width Modulation)</li><li>Ils sont compos√©s d'un adaptateur DC/DC (courant continu vers courant continu) et d'un coupe circuit. Le mppt comprend √©galement un adaptateur d'imp√©dence (il a une r√©sistance pour adapter l'amperage inject√© dans la batterie). Les mppt accepte des puissances nominales plus √©lev√©es, cad des tensions et intensit√© plus √©lev√©es.</li><li>Le r√©gulateur ou controleur de charge permet principalement de couper le circuit quand la batterie est recharg√©e en surveillant la tension et l'intensit√© de charge. Il coupe le circuit si leurs valeurs d√©passent les intervalles de r√©f√©rence (pour cela le regulateur arrete la charge temporairement et mesure la tension aux bornes des batteries).</li><li>Le mppt a un "algorithme" √©lectronique int√©gr√© qui va chercher le point de puissance optimal grace a son adaptateur d'impedance.</li><li>Si vous connectez plusieurs panneaux et plusieurs batteries, il est recommand√© d'avoir un regulateur pour couper la charge correctement lorsque la batterie est charg√©e.</li><li>Les tensions de charge de r√©f√©rence sont 12V,24V et 48V.</li><li>Cependant, les prix des mod√®les augmentent avec la puissance nominales (qui va d√©pendre de l'amperage) qu'ils acceptent.</li><li>Pour limiter l'intensit√© du courant de la production photovolta√Øque, il est plus judicieux d'utiliser des panneaux de plus forte puissance qui sont g√©n√©ralement √† des tensions plus √©lev√©es<ul><li>(rappel P=U*I,</li><li>rappel E=P*t se conserve dans un systeme ferm√©).</li></ul></li><li>note: si le systeme de stockage par batterie ou l'appareil connect√© √† vos panneaux n'absorbe pas toute la puissance produite, et si le r√©gulateur de charge ne coupe pas le circuit, le reste sera d√©gag√© en chaleur.</li><li>L'amperage va aussi dependre de la capacit√© de stockage de vos batteries, dimensionn√©es pour couvrir vos besoins pendant une periode d√©finie au dimensionnement.</li><li>Le courant de charge est calcul√© en divisant par 4 ou 5 la capacit√© nominale de la batterie exprim√©e en Ah qui devrait alors se recharger en 4 ou 5h. Cependant une batterie se rechargera aussi avec un courant de charge de la capacit√© nominale de la batterie divis√©e par 20 mais plus lentement (en 20h).</li><li>Dimensionnez et/ou agencez vos panneaux en cons√©quence.</li><li>Des montages de panneaux serie+paralelle peuvent permettrent d'ajuster tension et amperage.</li><li>Il y a enfin un dernier point sur lequel √™tre attentif: le d√©clenchement de la recharge de la batterie par le regulateur/controleur de charge (qui d√©clenche quand la tension de la batterie diminue en dessous d'un certain seuil).</li><li>En effet, si la puissance soutir√©e √† la batterie est trop faible, il est possible que le temps n√©cessaire √† la d√©charger avec votre consommation journali√®re pour d√©clencher la recharge dans le r√©gulateur d√©passe le temps d'ensoleillement journalier. La batterie ne se recharge alors pas du tout pendant la journ√©e.</li><li>Dans ce cas, votre batterie ne se rechargera qu'un jour sur deux ou sur trois (selon le seuil de d√©clenchement de la recharge du regulateur).</li><li>C'est un param√®tre √† prendre en compte dans le dimensionnement (non inclus dans la feuille de calcul).</li><li>Le r√©gulateur a 3 phases:</li><li>1.bulk: le regulateur laisse passer le courant</li><li>2.floating: le regulateur alterne interupteur ferm√©e et ouvert √† une fr√©quence donn√©e pour maintenir la batterie charg√©e</li><li>En outre il faut prendre des pr√©cautions car la charge des batteries pr√©sente certains risques.</li><li>3.absorption (pour les mppt): la tension de charge augmente un peu pour cr√©er une difference de potentiel suffisante pour continuer √† charger la batterie presque pleine.</li><li>En th√©orie le courant de charge diminue lorsque la batterie est presque recharg√©e (courant de queue etc.)</li><li>La charge de batteries en paralelle ou en s√©rie sur des batteries usag√©es qui n'ont pas les m√™mes tensions ou intensit√© pr√©sente en th√©orie des risques. En effet vous lirez un peu partout que la r√©sistance des fils pour relier ces batteries</li><li>cr√©ee des diff√©rences de potentiels entre les batteries qui produisent des d√©charges d'une batterie envers une autre etc.</li><li>cr√©ant des risques d'explosion, de degazage pour les batteries plomb etc.</li><li>Il faut bien se rapeller que les batteries sont des assemblages de composants unitaires de faible tension mis en s√©ries et en paralelle pour obtenir un g√©n√©rateur de l'intensit√© et la tension voulue et qu'√† priori faire de m√™me avec des batterie entiere ne pr√©sente pas vraiment de risques..</li><li>On parle souvent de "battery management system" (bms) "int√©gr√©" pour les batteries lithium ion.</li><li>En r√©alit√© le r√©gulateur de charge est d√©j√† un "bms". En th√©orie, le bms int√©gr√© s'assure que les tensions et les intensit√©s de chaque unit√© composant la batterie est la m√™me et la r√©√©quilibre au besoin.</li><li>On peut bien s√ªr s'interroger si tout ceci n'est pas une fa√ßon de rendre le stockage de l'√©nergie plus cher avec des composants BMS artificiellement chers et si ce n'est pas une fa√ßon d'√©viter de r√©utiliser des unit√©s de batteries usag√©es.</li><li>Il est par exemple √©tonnant qu'il n'existe pas de BMS pour r√©√©quilibrer automatiquement des batteries plomb acide, ce qui rendrait utilisable toutes les batteries mises au rebut de l'industrie automobile pour stocker l'√©nergie photovolta√Øque sans risque!</li><li>Dans tous les cas, si vous r√©utilisez des batteries au plomb, utilisez un r√©gulateur pour √©viter de continuer √† charger vos batteries recharg√©es (risques de production d'hydrogene) -ou si vous n'en utilisez pas dimensionnez avec beaucoup de soin-, √©vitez les d√©charges profondes, et maintenez les batteries √† une temperature constante autant que possible.</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>14. √âtape 14 - Montage et test</strong><div class='step-images count-5'><figure><img src='https://wiki.lowtechlab.org/images/thumb/4/44/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_171458_820.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_171458_820.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome IMG 20230821 171458 820.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/e/e9/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_171328_268.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_171328_268.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome IMG 20230821 171328 268.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/a/a3/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_173010_697.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_173010_697.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome IMG 20230821 173010 697.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/8/86/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_172639_858.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_IMG_20230821_172639_858.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome IMG 20230821 172639 858.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/1/12/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_montage_avec_DRL.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_montage_avec_DRL.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome montage avec DRL.jpg' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>On dimensionne sur un dixieme de la puissance de panneaux et un quart de la capacit√© de batterie de ce que la th√©orie nous a indiqu√© pour √™tre autonome 24h/24h et en capacit√© de recharger en un seul jour en hiver, soit un panneau de 120W et une vieille batterie de voiture de 45Ah en 12V.</li><li>C'est raccord avec une approche lowtech de ne faire tourner le serveur que lorsqu'il fait jour, pour une informatique qui respecte la temporalit√© humaine.</li><li>Pour √™tre bien en hiver (√† hypoth√®se 3,5h d'ensoleillement moyen), il faudrait une batterie de plus de 58Ah, mais pour raisons budg√©taire, on fait pour l'instant avec ce qu'on a! :).</li><li>Le regulateur utilis√© n'accepte pas les panneaux 40V donc on n'a pas utilis√© le panneau photovolta√Øque d'occasion de 180W √† 20‚Ç¨ trouv√© sur leboncoin, mais je ne manquerai pas d'updater ce tuto avec des raccordement de panneaux et de batteries d√®s que j'aurai le materiel et avec les valeurs de production hivernale si j'y arrive!</li><li>Etapes de montage:<ul><li>Raccorder un cable electrique de la borne + de la batterie √† la borne + du regulateur pwm (sortie batterie). Raccorder un cable electrique de la borne - de la batterie √† la borne - du regulateur pwm (sortie batterie)</li><li>Raccorder les panneaux aux cables mc4. Brancher le c√¥t√© d√©nud√© du cable + au + du r√©gulateur pwm (entree panneaux). Brancher le c√¥t√© d√©nud√© du cable - au - du r√©gulateur pwm (entree panneaux).</li><li>Brancher les pinces du convertisseur 12V batterie/5V USB avec le + sur le + et le - sur le -</li><li>Brancher le cable rj45 de votre box ou modem 4g au orange pi ou raspberry pi</li><li>Brancher le cable usb du orange pi ou raspberry pi au convertisseur 12V batterie/5V USB</li><li>Pour automatiser le fonctionnement quand il fait jour et √©teindre quand il fait nuit, on utiliser un module DRL (Daytime Running Light) de voiture. Le module est un interupteur qui laisse passer le courant quand la tension est sup√©rieure √† 13V (quand le panneau solaire charge la batterie). L'interrupteur est √† brancher borne + du IN sur le + de la batterie, borne - du IN sur le - de la batterie, borne + du out sur la pince rouge et borne - du out sur la pince rouge (entre la batterie et le convertisseur 12V batterie/5V USB).</li></ul></li><li>Attendre quelques minutes que ca boot. Et voil√† , votre serveur nextcloud est accessible en ligne ! :)</li><li>Notez que si vous voulez alimenter quelque chose en courant alternatif 220V, la seule chose qu'il manque au montage est un convertisseur DC/AC (courant continu alternatif) qu'on trouve facilement en magasin de camping car ou sur leboncoin.</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>15. √âtape 15 - Securisation du serveur</strong><p><strong>√âtapes :</strong></p><ol><li>Au niveau s√©curit√©, les failles connues des cpus peuvent √™tre trouv√©es sous linux en faisant:</li><li>grep -r . /sys/devices/system/cpu/vulnerabilities</li><li>Cette commande sur le orange pi (cpu CortexA55) avec dietpi install√© donne:</li><li>/sys/devices/system/cpu/vulnerabilities/spectre_v2:Mitigation: Unprivileged eBPF enabled</li><li>/sys/devices/system/cpu/vulnerabilities/itlb_multihit:Not affected</li><li>/sys/devices/system/cpu/vulnerabilities/mmio_stale_data:Not affected</li><li>/sys/devices/system/cpu/vulnerabilities/mds:Not affected</li><li>/sys/devices/system/cpu/vulnerabilities/l1tf:Not affected</li><li>/sys/devices/system/cpu/vulnerabilities/spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl</li><li>/sys/devices/system/cpu/vulnerabilities/tsx_async_abort:Not affected</li><li>/sys/devices/system/cpu/vulnerabilities/spectre_v1:Mitigation: __user pointer sanitization</li><li>/sys/devices/system/cpu/vulnerabilities/retbleed:Not affected</li><li>/sys/devices/system/cpu/vulnerabilities/srbds:Not affected</li><li>/sys/devices/system/cpu/vulnerabilities/meltdown:Not affected</li><li>Ayant test√© un orange pi un raspberry pi et un odroid, le probleme reste le m√™me. basiques:</li><li>on peut passer sa vie √† augmenter la s√©curit√© d'un systeme informatique...</li><li>trouver le bon compromis et √©valuer les risques ou appats en termes financiers.</li><li>Le hack est toujours possible, et vu le nombre de failles 0day non encore publi√©, quel que soit le systeme d'exploitation, la question est moins d'avoir un syst√®me infaillible, que de savoir de qui on cherche √† se prot√©ger quand on cherche √† "s√©curiser" ou r√©duire sa surface d'attaque.</li><li>Je pense que la philosophie libre reste sup√©rieure en termes de s√©curit√© car auditable et r√©parable plus vite par la "commu", mais il faut bien avouer que les reglages par d√©faut ne sont pas tip top car linux a √©t√© pens√© pour √™tre stable au d√©part (rappelez vous des √©crans bleux windows il y a 30 ans), et pas "s√©curis√©".</li><li>Ayant subi des hacks que je consid√®re tr√®s avanc√©s et pas √† la port√©e du premier venu(et ce quel que soit le syst√®me d'exploitation, quelle que soit la machine, et quel que soit le niveau de s√©curisation -hors compilation de kernel-), j'ai cherch√© √† s√©curiser mes dispositifs num√©riques et j'en arrive aujourd'hui √† penser que la "souverainet√©" num√©rique n'existe pas ou plus, les failles cr√©ent un march√© de la s√©curit√©, ca fait travailler des gens... Voir l'article int√©ressant de w0nderfall au sujet de la s√©curit√© sous linux: https://wonderfall.space/linux-securite/</li><li>Cependant quelques √©l√©ments car c'est un sujet sur lequel on trouve peu d'informations didactiques rassembl√©es.</li><li>-principe de limiter surface d'attaque : principe g√©n√©ral, la s√©curisation ne fait que diminuer la surface d'attaque potentielle</li><li>-acces physique s√©curis√© et config logicielle li√©e:</li><li>- acces physique: √† vous de voir</li><li>-mot de passe grub Lancer dans un terminal:</li><li>grub-mkpasswd-pbkdf2</li><li>Copier le texte qui commence par grub.pbkdf2.sha512.10000.xy</li><li>o√π xy est une longue suite de lettres et de chiffres</li><li>Ajouter les lignes suivantes √† un fichier /etc/grub.d/42_pw</li><li>en remplacant user par votre nom d'utilisateur linux et pw par le</li><li>texte pr√©cemment copi√©</li><li>cat << EOF<ul><li>set superusers=user</li></ul></li><li>password_pbkdf2 pw</li><li>EOF</li><li>lancer ensuite la commande</li><li>update-grub</li><li>-bons mots de passes en general</li><li>pour changer le mot de passer de l'utilisateur courant taper</li><li>passwd</li><li>pour changer le mot de passe de l'utilisateur root taper</li><li>sudo passwd root</li><li>-√©ventuellement v√©rification d'int√©grit√© du boot (voir ordinateurs de purism par exemple)</li><li>-chiffrer (crypter) ses supports de stockage:</li><li>https://doc.ubuntu-fr.org/tutoriel/chiffrer_ses_donnees</li><li>https://www.dwarmstrong.org/remote-unlock-dropbear/</li><li>s√©curit√© d'un serveur:</li><li>-apt update automatis√© : https://www.linuxtricks.fr/wiki/debian-activer-les-mises-a-jour-automatique-avec-unattended-upgrades</li><li>-ssh renforc√© :</li><li>lignes √† inclure dans votre configuration ssh (/etc/ssh/sshd_config):</li><li>Port 22 #changer sur un autre port si vous le souhaitez</li><li>Protocol 2</li><li>PermitRootLogin no</li><li>StrictModes yes</li><li>PermitEmptyPasswords no</li><li>X11Forwarding no</li><li>Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr</li><li>MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com</li><li>KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256</li><li>AllowTcpForwarding no</li><li>MaxSessions 1</li><li>UsePAM yes</li><li>AllowUsers user #remplacer par les utilisateurs autoris√©es</li><li>AllowGroups group #remplacer par les groupes autoris√©s</li><li>PasswordAuthentication no</li><li>AuthorizedKeysFile .ssh/authorized_keys</li><li>-firewall logiciel:</li><li>ufw: https://doc.ubuntu-fr.org/ufw</li><li>ou fichier de configuration iptables:</li><li>https://gitlab.com/aurelpere/bp028-hardening/-/blob/main/rhel_iptables_ipv4/files/server_firewall.sh</li><li>-backup: regle du 321 : 3 copies, 2 supports de stockages differents, 1 copie sur un autre lieux que les autres. borgbackup reste un standard pour sa fiabilit√© dans la communaut√© du libre (je confirme apres avoir test√© plusieurs trucs) et offre un cloud pas cher pour stocker des sauvegardes "remote" qui finance le developpement de son logiciel libre.</li><li>fail2ban: https://doc.ubuntu-fr.org/fail2ban</li><li>fail2ban pour nextcloud: https://tuxicoman.jesuislibre.net/2015/01/fail2ban-pour-owncloud-7-sur-debian-jessie.html</li><li>-desactiver ipv6 (ou configurer le firewall aussi pour ipv6)</li><li>3 m√©thodes pour d√©sactiver ipv6:</li><li>1.dans grub</li><li>2.avec sysctl</li><li>ajouter les lignes suivantes √† /etc/systcl.conf<ul><li>net.ipv6.conf.all.disable_ipv6 = 1</li><li>net.ipv6.conf.default.disable_ipv6 = 1</li><li>net.ipv6.conf.all.router_solicitations = 0</li><li>net.ipv6.conf.default.router_solicitations = 0</li><li>net.ipv6.conf.all.accept_ra_rtr_pref = 0</li><li>net.ipv6.conf.default.accept_ra_rtr_pref = 0</li><li>net.ipv6.conf.all.accept_ra_pinfo = 0</li><li>net.ipv6.conf.default.accept_ra_pinfo = 0</li><li>net.ipv6.conf.all.accept_ra_defrtr = 0</li><li>net.ipv6.conf.default.accept_ra_defrtr = 0</li><li>net.ipv6.conf.all.autoconf = 0</li><li>net.ipv6.conf.default.autoconf = 0</li><li>net.ipv6.conf.all.accept_redirects = 0</li><li>net.ipv6.conf.default.accept_redirects = 0</li><li>net.ipv6.conf.all.accept_source_route = 0</li><li>net.ipv6.conf.default.accept_source_route = 0</li><li>net.ipv6.conf.all.max_addresses = 1</li><li>net.ipv6.conf.default.max_addresses = 1</li></ul></li><li>3.avec le network manager nmcli</li><li>https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/using-networkmanager-to-disable-ipv6-for-a-specific-connection_configuring-and-managing-networking</li><li>-s√©curiser le serveur en cas de multi utilisateur ou autres utilisateurs ayant obtenu un acc√®s:</li><li>listes de fichiers √† s√©curiser (permissions etc.): https://linuxfr.org/forums/linux-general/posts/liste-des-fichiers-linux-a-securiser-owner-group-permissions-setuid-setgid-sticky-bit</li><li>guides de durcissement anssi : https://www.ssi.gouv.fr/guide/recommandations-de-securite-relatives-a-un-systeme-gnulinux/</li><li>Pour aller plus loin en termes de s√©curit√©:</li><li>firewall physique libre: pcengines/ logiciel libre OPNSense</li><li>fail2ban avec listes g√©ographiques: https://thecustomizewindows.com/2016/11/fail2ban-geoip-action-script-block-ssh-country/</li><li>Cr√©er un sas de connection √† votre service en ligne (MySafeip): https://linuxfr.org/news/mysafeip-un-tiers-de-confiance-pour-votre-pare-feu</li><li>s√©curiser les services systemd linux: https://github.com/juju4/ansible-harden-systemd</li><li>compiler un kernel :</li><li>https://doc.ubuntu-fr.org/tutoriel/comment_compiler_un_kernel_de_kernel.org</li><li>https://github.com/robertdebock/ansible-role-kernel</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
          <li>
            
            
              <strong>16. √âtape 16 - Activer le wifi lors de l'installation (par exemple avec un raspberry)</strong><div class='step-images count-6'><figure><img src='https://wiki.lowtechlab.org/images/thumb/7/74/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifi2.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifi2.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome wifi2.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/4/4f/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifi3.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifi3.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome wifi3.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/e/e1/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifiscan.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifiscan.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome wifiscan.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/b/b4/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifiscan2.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifiscan2.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome wifiscan2.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/a/a6/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifiscan3.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifiscan3.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome wifiscan3.jpg' loading='lazy'></figure><figure><img src='https://wiki.lowtechlab.org/images/thumb/f/fc/Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifiscan4.jpg/800px-Serveur_orangepi-raspberry_nextcloud_en_photovolta_que_autonome_wifiscan4.jpg' alt='Serveur orangepi-raspberry nextcloud en photovolta que autonome wifiscan4.jpg' loading='lazy'></figure></div><p><strong>√âtapes :</strong></p><ol><li>wpa2:</li><li>Lorsque vous d√©marrez pour la premiere fois votre raspberry avec dietpi sur la cl√© usb ou la carte sd, le programme d'installation va vous afficher un menu suite √† une erreur ("Checking ipv4 network connectivity") [...] ping: connect: Network is unreachabel")</li><li>Aller alors dans "network-settings" puis suivez les menus indiqu√©s dans les images jointes</li><li>wpa3: voir etape 6</li></ol>
            

            
            
            
              
              
                
                
                
              

              
            
          </li>
        
      </ol>
    
  </div>

  

  <!-- Lightbox overlay for viewing images -->
  <div id="lightbox" class="lightbox-overlay" aria-hidden="true">
    <button id="lb-close" class="lightbox-close" aria-label="Fermer">√ó</button>
    <!-- Prev/Next visible controls -->
    <button id="lb-prev" class="lightbox-control lightbox-prev" aria-label="Image pr√©c√©dente">‚Äπ</button>
    <button id="lb-next" class="lightbox-control lightbox-next" aria-label="Image suivante">‚Ä∫</button>
    <div class="lightbox-content">
      <img id="lb-img" src="" alt="">
      <div id="lb-caption" class="lightbox-caption"></div>
    </div>
  </div>

  <script>
    // JS lightbox: delegate clicks from step-images figures
    document.addEventListener('click', function(ev){
      const fig = ev.target.closest('.step-images figure');
      if(!fig) return;
      const container = fig.closest('.step-images');
      if(!container) return;
      const figures = Array.from(container.querySelectorAll('figure'));
      const idx = figures.indexOf(fig);
      if(idx < 0) return;

      const overlay = document.getElementById('lightbox');
      const imgEl = document.getElementById('lb-img');
      const captionEl = document.getElementById('lb-caption');
      const btnPrev = document.getElementById('lb-prev');
      const btnNext = document.getElementById('lb-next');

      let current = idx;
      function show(i){
        const f = figures[i];
        const im = f.querySelector('img');
        const cap = f.querySelector('figcaption');
        if(im){ imgEl.src = im.src; imgEl.alt = im.alt || ''; }
        captionEl.textContent = cap ? cap.textContent : '';
        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden','false');
      }
      function hide(){ overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); }

      show(current);

      // close handlers
      document.getElementById('lb-close').onclick = hide;
      overlay.onclick = function(e){ if(e.target === overlay) hide(); };
      // prev/next click handlers
      if(btnPrev){ btnPrev.onclick = function(e){ e.stopPropagation(); current = Math.max(current-1, 0); show(current); }; }
      if(btnNext){ btnNext.onclick = function(e){ e.stopPropagation(); current = Math.min(current+1, figures.length-1); show(current); }; }
      document.onkeydown = function(e){
        if(e.key === 'Escape') hide();
        if(e.key === 'ArrowRight') { current = Math.min(current+1, figures.length-1); show(current); }
        if(e.key === 'ArrowLeft') { current = Math.max(current-1, 0); show(current); }
      };
    });
  </script>

  <style>
    /* lightbox visible controls styling */
    .lightbox-control {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.35);
      color: #fff;
      border: none;
      width: 44px;
      height: 70px;
      font-size: 2rem;
      line-height: 1;
      border-radius: 6px;
      cursor: pointer;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .lightbox-prev { left: 12px; }
    .lightbox-next { right: 12px; }
    .lightbox-control:hover { background: rgba(0,0,0,0.6); }
    @media (max-width: 600px){ .lightbox-control { width: 36px; height: 56px; font-size: 1.6rem; } }
  </style>

  

</body>
</html>